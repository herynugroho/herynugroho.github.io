<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistem Absensi Magang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .bg-primary { background-color: #2563eb; }
        .hidden { display: none !important; }
        /* Agar logo tidak bisa di-drag/seleksi */
        .no-select { -webkit-user-select: none; user-select: none; pointer-events: none; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden pt-[env(safe-area-inset-top)] bg-gray-100">

    <div id="loginPage" class="flex-1 flex flex-col items-center justify-center p-6 z-20 relative">
        
        <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 relative overflow-hidden">
             <img src="logo-prima-vision.png" alt="ornament" class="absolute -top-10 -right-10 w-40 opacity-[0.03] no-select grayscale transform rotate-12">

            <div class="text-center mb-8">
                <img src="logo-prima-vision.png" alt="Logo Prima Vision" class="h-16 w-auto mx-auto mb-6 object-contain">
                
                <h2 class="text-2xl font-bold text-gray-800">Absensi Magang</h2>
                <p class="text-gray-500 text-sm mt-1">Masuk sebagai Peserta atau Admin</p>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 pl-1">NIK / Username</label>
                    <div class="flex items-center border-2 border-gray-100 rounded-xl p-3 bg-gray-50 focus-within:border-blue-500 transition">
                        <i class="fa-solid fa-user text-gray-400 mr-3"></i>
                        <input type="text" id="loginNik" class="bg-transparent outline-none w-full font-semibold text-gray-700" placeholder="Masukkan NIK">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 pl-1">Password</label>
                    <div class="flex items-center border-2 border-gray-100 rounded-xl p-3 bg-gray-50 focus-within:border-blue-500 transition">
                         <i class="fa-solid fa-lock text-gray-400 mr-3"></i>
                        <input type="password" id="loginPass" class="bg-transparent outline-none w-full font-semibold text-gray-700" placeholder="••••••••">
                    </div>
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg hover:shadow-blue-500/30 active:scale-[0.98]">
                    Masuk Aplikasi
                </button>
            </div>
        </div>
        <p class="text-gray-400 text-xs mt-8 font-medium">© 2025 Prima Vision Internal System</p>
    </div>

    <div id="dashboardPage" class="hidden w-full h-full bg-white relative flex flex-col">
        <div class="bg-primary text-white p-6 pb-24 rounded-b-[3rem] shadow-lg flex-none relative z-10">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-blue-100 text-sm font-medium tracking-wide">Selamat Datang,</p>
                    <h1 id="userNama" class="text-[22px] font-bold mt-1 tracking-tight leading-tight">Nama User</h1>
                    <div class="flex flex-wrap items-center gap-2 mt-3">
                         <p id="userBagian" class="text-[10px] font-extrabold text-blue-600 bg-white px-3 py-1 rounded-full inline-block uppercase tracking-widest shadow-sm">Divisi</p>
                         <span class="text-blue-300 text-xs">•</span>
                         <p id="userKampus" class="text-[11px] font-medium text-blue-50 truncate max-w-[180px] tracking-wide">Kampus</p>
                    </div>
                </div>
                <button onclick="handleLogout()" class="bg-white bg-opacity-20 p-3 rounded-full text-white hover:bg-opacity-30 transition backdrop-blur-md shadow-sm active:scale-95">
                    <i class="fa-solid fa-right-from-bracket text-lg pl-0.5"></i>
                </button>
            </div>
        </div>

        <div class="px-6 -mt-16 flex-none grid grid-cols-2 gap-5 relative z-20">
            <button onclick="openCamera('Check In')" class="bg-white p-6 rounded-3xl shadow-[0_8px_25px_rgba(0,0,0,0.07)] active:scale-95 transition flex flex-col items-center gap-3 border-2 border-transparent hover:border-green-100 group">
                <div class="w-16 h-16 bg-green-50 text-green-500 rounded-2xl flex items-center justify-center text-3xl group-hover:bg-green-500 group-hover:text-white transition-colors duration-300 shadow-sm">
                    <i class="fa-solid fa-camera"></i>
                </div>
                <span class="font-bold text-gray-800 text-sm uppercase tracking-wider">Check In</span>
                <p class="font-bold text-gray-800 text-sm uppercase tracking-wider">(Datang)</p>
            </button>
            <button onclick="openCamera('Check Out')" class="bg-white p-6 rounded-3xl shadow-[0_8px_25px_rgba(0,0,0,0.07)] active:scale-95 transition flex flex-col items-center gap-3 border-2 border-transparent hover:border-red-100 group">
                <div class="w-16 h-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center text-3xl group-hover:bg-red-500 group-hover:text-white transition-colors duration-300 shadow-sm">
                    <i class="fa-solid fa-sign-out-alt"></i>
                </div>
                <span class="font-bold text-gray-800 text-sm uppercase tracking-wider">Check Out</span>
                <span class="font-bold text-gray-800 text-sm uppercase tracking-wider">(Pulang)</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 mt-6 pb-4">
            <h3 class="font-bold text-gray-800 mb-4 text-xs uppercase tracking-widest flex items-center gap-2 opacity-80">
                <i class="fa-solid fa-clock-rotate-left text-blue-500"></i> Riwayat Hari Ini
            </h3>
            <div id="historyContainer" class="space-y-3"></div>
        </div>

        <div class="p-6 pb-8 text-center mt-auto border-t border-gray-100 bg-white">
            <img src="logo-prima-vision.png" alt="Prima Vision Logo" class="h-10 mx-auto mb-3 object-contain">
            
            <h2 class="text-gray-800 font-bold text-sm tracking-wide uppercase mb-2">PT Citra Prima Media</h2>
            
            <div class="text-[10px] text-gray-400 leading-relaxed font-medium">
                <p>Jl. A. P. Pettarani Diamond Building No. 07</p>
                <p>Kota Makassar, Sulawesi Selatan 90231</p>
                <div class="mt-1 flex flex-wrap justify-center gap-x-3 gap-y-1 text-blue-500">
                    <span><i class="fa-solid fa-phone text-[9px]"></i> (0411) 423-848</span>
                    <span><i class="fa-solid fa-envelope text-[9px]"></i> bod@primahome.id</span>
                </div>
            </div>
        </div>
    </div>

    <div id="adminPage" class="hidden w-full h-full bg-gray-50 flex flex-col relative">
        
        <div class="bg-white px-6 py-5 shadow-sm z-10 flex justify-between items-center border-b border-gray-100 relative overflow-hidden">
             <img src="logo-prima-vision.png" alt="ornament" class="absolute top-2 right-4 w-32 opacity-[0.05] grayscale no-select pointer-events-none">

            <div>
                <h1 class="font-black text-gray-800 text-xl tracking-tight">Administrator</h1>
                <p class="text-xs font-medium text-gray-400">Rekapitulasi Absensi Prima Vision</p>
            </div>
            <div class="flex gap-3 relative z-10">
                <button onclick="openSpreadsheet()" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-sm hover:bg-emerald-600 flex items-center gap-2 transition active:scale-95">
                    <i class="fa-solid fa-table-cells"></i> Excel
                </button>
                <button onclick="handleLogout()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-100 transition active:scale-95">
                    Keluar
                </button>
            </div>
        </div>

        <div class="px-6 py-5 bg-white shadow-[0_4px_20px_-10px_rgba(0,0,0,0.1)] flex flex-col gap-4 z-10 rounded-b-3xl mx-2 mt-2">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider ml-1">Filter Nama</label>
                    <div class="relative mt-1">
                        <select id="adminFilter" onchange="renderAdminData()" class="w-full appearance-none p-3 pl-4 pr-10 border-2 border-gray-100 rounded-2xl text-sm font-semibold text-gray-700 bg-gray-50 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition">
                            <option value="ALL">Semua Anak Magang</option>
                        </select>
                         <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider ml-1">Filter Tanggal</label>
                    <div class="relative mt-1">
                        <input type="date" id="dateFilter" onchange="renderAdminData()" class="w-full p-3 border-2 border-gray-100 rounded-2xl text-sm font-semibold text-gray-700 bg-gray-50 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition text-center uppercase">
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4" id="adminContent">
            <div class="flex flex-col items-center justify-center mt-20 text-gray-400">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-4 text-blue-500"></i>
                <p class="font-medium animate-pulse">Sedang memuat data...</p>
            </div>
        </div>
        
        <button onclick="fetchDataFromServer('ADMIN')" class="absolute bottom-8 right-8 w-16 h-16 bg-blue-600 text-white rounded-full shadow-[0_10px_30px_rgba(37,99,235,0.4)] flex items-center justify-center text-2xl hover:bg-blue-700 transition z-20 active:scale-90 hover:rotate-180 duration-500">
            <i class="fa-solid fa-arrows-rotate"></i>
        </button>
    </div>

    <div id="cameraModal" class="hidden fixed inset-0 z-50 bg-black flex flex-col">
        <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden rounded-b-3xl">
            <video id="video" autoplay playsinline class="absolute w-full h-full object-cover filter brightness-110"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div class="absolute inset-0 border-2 border-white opacity-20 m-8 rounded-3xl pointer-events-none grid grid-cols-3 grid-rows-3">
                <div class="border-r border-b border-white border-opacity-20"></div><div class="border-r border-b border-white border-opacity-20"></div><div class="border-b border-white border-opacity-20"></div>
                <div class="border-r border-b border-white border-opacity-20"></div><div class="border-r border-b border-white border-opacity-20"></div><div class="border-b border-white border-opacity-20"></div>
                <div class="border-r border-white border-opacity-20"></div><div class="border-r border-white border-opacity-20"></div><div></div>
            </div>
             <p class="absolute top-10 text-white bg-black bg-opacity-50 px-4 py-2 rounded-full text-sm font-medium backdrop-blur-md">Pastikan wajah terlihat jelas</p>
        </div>
        <div class="bg-black p-8 flex flex-col items-center pb-12">
            <p id="cameraStatusText" class="text-white mb-8 font-bold text-lg tracking-wide">Ambil Foto</p>
            <div class="flex gap-12 items-center">
                <button onclick="closeCamera()" class="text-white opacity-60 hover:opacity-100 transition font-medium">Batal</button>
                <button onclick="takePicture()" class="w-20 h-20 bg-white rounded-full border-4 border-blue-200 flex items-center justify-center shadow-[0_0_30px_rgba(255,255,255,0.3)] active:scale-90 transition-all duration-300 group relative">
                    <div class="absolute inset-0 rounded-full bg-blue-500 opacity-0 group-active:opacity-20 transition duration-300"></div>
                    <div class="w-16 h-16 bg-white rounded-full border-[3px] border-gray-800 group-hover:border-blue-500 transition"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="hidden fixed inset-0 z-[60] bg-black bg-opacity-80 flex items-center justify-center flex-col backdrop-blur-md">
        <div class="relative w-20 h-20">
             <div class="absolute top-0 left-0 w-full h-full border-4 border-blue-200 rounded-full animate-ping opacity-20"></div>
             <div class="absolute top-0 left-0 w-full h-full border-4 border-t-blue-500 border-r-blue-500 border-b-transparent border-l-transparent rounded-full animate-spin"></div>
        </div>
        <p class="text-white font-bold mt-6 tracking-wider">Mengirim Data...</p>
        <p class="text-blue-200 text-xs mt-2 animate-pulse">Mohon tunggu sebentar</p>
    </div>

    <script>
        // --- KONFIGURASI ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwEMLvNup4NKhEAeT5d7l5DNFXRxDoet1OmcjCvWMGNvGZo0_FvCqhLbiYZIGZTo3LNgQ/exec"; 
        
        // --- GANTI INI DENGAN URL SPREADSHEET ANDA ---
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/13xFt1CVVn5uBR_iOqOVGbOtGZ7ZVkP3u2xDFHKJc6ps/edit?usp=sharing"; 

        const internData = {
            "7371092004030008": { name: "Habiburrahman", role: "Intern NOC", campus: "Univ. Muslim Indonesia" },
            "7306084702020003": { name: "Andi Salsabila R", role: "Intern NOC", campus: "Poltek Negeri Ujung Pandang" },
            "7371132204020002": { name: "Muh. Addeta Rukmadi", role: "Intern NOC", campus: "Univ. Hasanuddin" },
            "7315017108030002": { name: "Jely Cahyani", role: "Intern Marcom", campus: "Univ. Muslim Indonesia" },
            "7371095201020002": { name: "Dwidya Indah P", role: "Intern Marcom", campus: "Univ. Muslim Indonesia" },
            "7304075404040001": { name: "Nurul Fatimah", role: "Intern Admin Mkt", campus: "Poltek Ujung Pandang" },
            "7309015303030002": { name: "Faiqah Nurul Utami", role: "Intern Legal", campus: "Univ. Hasanuddin" },
            "7604034505020006": { name: "Nurul Khalifah", role: "Intern Legal", campus: "IAIN Pare-Pare" },
            "7317096308020001": { name: "Dian Pratiwi", role: "Intern Helpdesk", campus: "Univ. Negeri Makassar" },
            "3171080705020003": { name: "Muhammad Fadhil", role: "Intern IT Dev", campus: "Univ. Islam Makassar" }
        };

        let currentUser = null;
        let currentAction = ""; 
        let rawData = [];

        // --- HELPER FUNCTIONS ---
        function getEmbedLink(driveLink) {
            try {
                const id = driveLink.match(/[-\w]{25,}/);
                if(id) return `https://lh3.googleusercontent.com/d/${id[0]}=s200`;
            } catch (e) { }
            return "https://via.placeholder.com/150?text=No+Img";
        }

        function openSpreadsheet() {
            window.open(GOOGLE_SHEET_URL, '_blank');
        }

        // --- LOGIC UTAMA ---
        function handleLogin() {
            const nik = document.getElementById('loginNik').value.trim();
            const pass = document.getElementById('loginPass').value.trim();
            if (!nik) return alert("Masukkan NIK");

            if (nik.toLowerCase() === "admin" && pass === "Kulupai") {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('adminPage').classList.remove('hidden');
                setupAdminFilter();
                document.getElementById('dateFilter').valueAsDate = new Date();
                fetchDataFromServer("ADMIN");   
                return;
            }

            if (internData[nik] && pass === nik) {
                currentUser = { ...internData[nik], nik: nik };
                showUserDashboard();
            } else {
                alert("NIK/Password Salah");
            }
        }

        function showUserDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            document.getElementById('userNama').innerText = currentUser.name;
            document.getElementById('userBagian').innerText = currentUser.role;
            document.getElementById('userKampus').innerText = currentUser.campus;
            fetchDataFromServer("USER");
        }

        function handleLogout() {
            currentUser = null; rawData = [];
            document.getElementById('loginNik').value = "";
            document.getElementById('loginPass').value = "";
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function fetchDataFromServer(mode) {
            const container = mode === "ADMIN" ? document.getElementById('adminContent') : document.getElementById('historyContainer');
            if(mode === "ADMIN") {
                 container.innerHTML = `
                    <div class="flex flex-col items-center justify-center mt-20 text-gray-400">
                        <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-4 text-blue-500"></i>
                        <p class="font-medium animate-pulse">Sedang memuat data...</p>
                    </div>`;
            } else {
                 container.innerHTML = `
                    <div class="flex justify-center py-6">
                        <i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i>
                    </div>`;
            }
            
            fetch(APPS_SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                rawData = data;
                if (mode === "ADMIN") renderAdminData();
                else renderUserHistory();
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = '<div class="text-center text-red-400 py-4 font-medium bg-red-50 rounded-xl border border-red-100">Gagal koneksi server. Coba refresh.</div>';
            });
        }

        function setupAdminFilter() {
            const select = document.getElementById('adminFilter');
            select.innerHTML = '<option value="ALL">Semua Anak Magang</option>';
            Object.values(internData).forEach(u => select.innerHTML += `<option value="${u.name}">${u.name}</option>`);
        }

        // --- RENDER ADMIN (DIPERCANTIK) ---
        function renderAdminData() {
            const nameFilter = document.getElementById('adminFilter').value;
            const dateFilter = document.getElementById('dateFilter').value; 
            const container = document.getElementById('adminContent');
            
            let filtered = rawData.filter(item => {
                const matchName = nameFilter === "ALL" || item.nama === nameFilter;
                let matchDate = true;
                if(dateFilter) {
                    const itemDate = new Date(item.waktu).toISOString().split('T')[0];
                    matchDate = itemDate === dateFilter;
                }
                return matchName && matchDate;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center mt-20 text-gray-300 gap-3">
                    <i class="fa-regular fa-folder-open text-5xl"></i>
                    <p class="text-sm font-medium">Tidak ada data ditemukan.</p>
                </div>`; 
                return;
            }

            let html = '<div class="space-y-4 pb-24">';
            filtered.forEach(item => {
                const dateObj = new Date(item.waktu);
                const dateStr = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' });
                const timeStr = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const isCheckIn = item.status === 'Check In';
                const statusColor = isCheckIn ? 'text-green-600 bg-green-50 border-green-100' : 'text-red-600 bg-red-50 border-red-100';
                const statusIcon = isCheckIn ? 'fa-camera' : 'fa-person-walking-arrow-right';
                const fotoUrl = getEmbedLink(item.foto); 

                html += `
                <div class="bg-white p-4 rounded-[20px] shadow-[0_2px_15px_-5px_rgba(0,0,0,0.08)] border border-gray-50 flex items-start gap-4 transition hover:-translate-y-1">
                    <div class="w-16 h-16 flex-none rounded-2xl bg-gray-100 overflow-hidden cursor-pointer shadow-sm relative group" onclick="window.open('${item.foto}', '_blank')">
                         <img src="${fotoUrl}" class="w-full h-full object-cover transition group-hover:scale-110 duration-500">
                         <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800 text-[15px] truncate">${item.nama}</h4>
                            <span class="text-xs font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">${dateStr}</span>
                        </div>
                        <p class="text-xs text-gray-500 truncate font-medium mt-0.5">${item.bagian}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs px-3 py-1.5 rounded-xl ${statusColor} font-bold border flex items-center gap-2">
                                <i class="fa-solid ${statusIcon}"></i> ${item.status}
                            </span>
                            <span class="font-black text-gray-700 text-base">${timeStr}</span>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html + '</div>';
        }

        // --- RENDER USER (DIPERCANTIK) ---
        function renderUserHistory() {
            const container = document.getElementById('historyContainer');
            const todayStr = new Date().toLocaleDateString('id-ID'); 
            const myHistory = rawData.filter(item => {
                const itemDate = new Date(item.waktu).toLocaleDateString('id-ID');
                return item.nik == currentUser.nik && itemDate === todayStr;
            });

            if (myHistory.length === 0) {
                container.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center border-2 border-dashed border-gray-200">
                    <i class="fa-solid fa-camera-retro text-4xl text-gray-200 mb-3"></i>
                    <p class="text-gray-400 text-sm font-medium">Belum ada aktivitas absensi hari ini.</p>
                </div>`; 
                return;
            }

            let html = '';
            myHistory.forEach(h => {
                const timeStr = new Date(h.waktu).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                const isCheckIn = h.status === 'Check In';
                const fotoUrl = getEmbedLink(h.foto);

                html += `
                <div class="flex justify-between items-center p-4 bg-white rounded-[20px] shadow-sm border-l-[6px] ${isCheckIn ? 'border-green-500' : 'border-red-500'} mb-3 transition hover:shadow-md">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl overflow-hidden bg-gray-100 shadow-sm">
                             <img src="${fotoUrl}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <p class="text-[15px] font-bold text-gray-700 flex items-center gap-2">
                                ${h.status} 
                                ${isCheckIn ? '<i class="fa-solid fa-circle-check text-green-500 text-xs"></i>' : '<i class="fa-solid fa-circle-check text-red-500 text-xs"></i>'}
                            </p>
                            <p class="text-xs text-gray-400 font-medium mt-0.5">Terverifikasi Sistem</p>
                        </div>
                    </div>
                    <span class="text-lg font-black text-gray-700">${timeStr}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- KAMERA (TETAP SAMA) ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        let stream = null;

        function openCamera(actionType) {
            currentAction = actionType;
            document.getElementById('cameraStatusText').innerText = `Ambil Foto ${actionType}`;
            document.getElementById('cameraModal').classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => { stream = s; video.srcObject = stream; });
        }

        function closeCamera() {
            if (stream) stream.getTracks().forEach(track => track.stop());
            document.getElementById('cameraModal').classList.add('hidden');
        }

        function takePicture() {
            if (!navigator.geolocation) return alert("GPS Wajib Aktif");
            document.getElementById('loadingOverlay').classList.remove('hidden');
            navigator.geolocation.getCurrentPosition(pos => {
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const payload = {
                    nik: currentUser.nik, nama: currentUser.name, bagian: currentUser.role, campus: currentUser.campus,
                    status: currentAction, lat: pos.coords.latitude, long: pos.coords.longitude,
                    foto: canvas.toDataURL('image/png')
                };

                fetch(APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                }).then(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    closeCamera();
                    alert("Berhasil!");
                    fetchDataFromServer("USER"); 
                }).catch(e => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    alert("Gagal kirim data.");
                });
            }, () => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert("Gagal GPS");
            });
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>