<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Home Generator - Safe Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .row-complete { background-color: #f0fdf4 !important; border-left: 5px solid #22c55e; }
        .btn-active-copy { background-color: #64748b !important; transform: scale(0.95); }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-6xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
                <p class="text-slate-500 text-xs uppercase font-bold tracking-widest">Total Data</p>
                <h2 id="totalCount" class="text-3xl font-black text-slate-800">0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
                <p class="text-slate-500 text-xs uppercase font-bold tracking-widest">Sudah Tercopy</p>
                <h2 id="successCount" class="text-3xl font-black text-green-600">0</h2>
            </div>
            <div id="sessionCard" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center transition-all duration-500">
                <p class="text-slate-500 text-xs uppercase font-bold tracking-widest">Sesi Pengiriman (Maks 5)</p>
                <h2 id="sessionCount" class="text-3xl font-black text-blue-600">0 / 5</h2>
                <div id="pauseAlert" class="hidden mt-2 text-red-600 font-bold text-xs blink">‚ö†Ô∏è JEDA DULU! TUNGGU 5 MENIT</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="w-full">
                    <h1 class="text-xl font-bold text-slate-800">Prima Home Generator üöÄ</h1>
                </div>
                <input type="file" id="uploadExcel" accept=".xlsx, .xls" 
                    class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer" />
                <button onclick="resetSession()" class="bg-slate-800 text-white px-6 py-2 rounded-full text-sm font-bold hover:bg-slate-700 whitespace-nowrap">Reset Sesi Baru</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-slate-800 text-white text-left text-xs uppercase tracking-wider">
                        <th class="p-4 border-b border-slate-700">No. HP</th>
                        <th class="p-4 border-b border-slate-700">ID & Nama</th>
                        <th class="p-4 border-b border-slate-700 w-1/3">Pesan (Random)</th>
                        <th class="p-4 border-b border-slate-700 text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="text-sm">
                    <tr><td colspan="4" class="p-12 text-center text-slate-400 italic">Upload file Excel untuk memulai...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let rowTracker = {};
        let processedTotal = 0;
        let sessionCounter = 0;

        const templates = [
            "Halo {{nama}}, perkenalkan kami dari Prima Home. Sekadar pengingat rutin untuk jadwal jatuh tempo layanan internet Bapak/Ibu periode ini. Jika sudah diproses, mohon abaikan pesan ini ya. Terima kasih.",
            "Selamat siang {{nama}}, salam dari kami tim layanan Prima Home. Kami ingin menginformasikan jadwal jatuh tempo rutin agar koneksi internet Bapak/Ibu tetap lancar. Abaikan pesan ini jika sudah dilakukan ya.",
            "Permisi {{nama}}, kami admin Prima Home ingin memastikan kenyamanan akses internet Bapak/Ibu melalui pengingat rutin jadwal jatuh tempo ini. Jika sudah selesai, mohon abaikan saja.",
            "Halo {{nama}}, salam hangat dari kami Prima Home. Ini adalah info rutin mengenai tanggal jatuh tempo layanan internet Bapak/Ibu agar tetap stabil. Mohon diabaikan jika sudah diselesaikan sebelumnya.",
            "Selamat pagi {{nama}}, perkenalkan kami dari Prima Home. Sekadar info rutin untuk jadwal jatuh tempo bulan ini demi kelancaran koneksi internet Bapak/Ibu. Abaikan pesan ini jika sudah aman ya.",
            "Halo {{nama}}, kami dari layanan pelanggan Prima Home. Ingin memberikan informasi rutin terkait jadwal jatuh tempo layanan internet periode ini. Jika sudah selesai diproses, mohon diabaikan.",
            "Hi {{nama}}, kami perwakilan dari Prima Home. Ingin memastikan Bapak/Ibu tetap mendapatkan koneksi internet terbaik dengan pengingat rutin jadwal ini. Abaikan jika sudah ya, terima kasih.",
            "Halo {{nama}}, kami admin Prima Home. Sekadar pengingat rutin untuk tanggal jatuh tempo demi menjaga stabilitas layanan internet Bapak/Ibu. Mohon abaikan pesan ini jika sudah dilakukan.",
            "Permisi {{nama}}, kami dari tim Prima Home ingin menginformasikan kembali jadwal rutin jatuh tempo periode ini agar internet tetap aktif. Jika sudah selesai, abaikan saja pesan ini.",
            "Halo {{nama}}, salam dari kami Prima Home. Kami ingin memberikan informasi rutin mengenai tanggal jatuh tempo layanan internet Bapak/Ibu. Mohon abaikan jika sudah dilakukan sebelumnya.",
            "Selamat siang {{nama}}, kami dari Prima Home ingin menyapa sekaligus memberikan info rutin jadwal jatuh tempo internet Bapak/Ibu. Abaikan pesan ini jika pembayarannya sudah selesai ya.",
            "Halo {{nama}}, perkenalkan kami admin Prima Home. Ingin memastikan Bapak/Ibu tidak terlewat jadwal jatuh tempo rutin bulan ini agar internet tetap lancar. Mohon diabaikan jika sudah diproses.",
            "Permisi Bapak/Ibu {{nama}}, kami dari tim Prima Home. Sekadar memberikan informasi rutin terkait jadwal jatuh tempo layanan internet Anda. Jika sudah dilakukan, mohon abaikan pesan singkat ini.",
            "Halo {{nama}}, kami perwakilan Prima Home ingin menginfokan pengingat rutin jadwal jatuh tempo demi kenyamanan akses internet Bapak/Ibu. Abaikan pesan ini jika sudah aman terkendali.",
            "Selamat sore {{nama}}, salam hangat dari kami Prima Home. Kami ingin memberikan update rutin mengenai jadwal jatuh tempo layanan internet periode ini. Mohon diabaikan jika sudah selesai.",
            "Halo {{nama}}, kami dari Prima Home. Ingin memastikan stabilitas internet Bapak/Ibu tetap terjaga dengan memberikan info rutin jadwal jatuh tempo ini. Abaikan saja jika sudah diproses ya.",
            "Selamat pagi {{nama}}, kami admin Prima Home. Sekadar sapaan rutin sekaligus info jadwal jatuh tempo layanan internet Bapak/Ibu bulan ini. Mohon diabaikan jika sudah dilakukan, terima kasih.",
            "Permisi {{nama}}, kami dari layanan Prima Home. Ingin menginformasikan jadwal rutin jatuh tempo demi menjaga kelancaran koneksi internet Bapak/Ibu. Jika sudah diselesaikan, mohon abaikan saja.",
            "Halo {{nama}}, salam dari tim Prima Home. Kami hadir memberikan pengingat rutin untuk jadwal jatuh tempo internet Bapak/Ibu agar tetap aktif. Mohon abaikan pesan ini jika sudah diproses sebelumnya.",
            "Selamat siang {{nama}}, kami admin Prima Home. Ingin memastikan Bapak/Ibu tetap nyaman berinternet dengan info rutin jadwal jatuh tempo periode ini. Abaikan jika sudah selesai, terima kasih."
        ];

        document.getElementById('uploadExcel').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF: 'dd-mm-yyyy'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Reset State
                rowTracker = {}; 
                processedTotal = 0;
                sessionCounter = 0;
                document.getElementById('totalCount').innerText = jsonData.length;
                document.getElementById('successCount').innerText = "0";
                updateSessionUI();
                
                renderTable(jsonData);
            };
            reader.readAsArrayBuffer(file);
        });

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            data.forEach((row, index) => {
                rowTracker[index] = { hp: false, name: false, msg: false, completed: false };
                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors";

                const jtVal = row.jt ? row.jt.toString().split('T')[0] : 'TGL';
                const formattedName = `${jtVal}_${row.no_pelanggan || 'ID'}_${row.nama_pelanggan || 'PLG'}`;
                const randomMsg = templates[Math.floor(Math.random() * templates.length)].replace('{{nama}}', row.nama_pelanggan || 'Bapak/Ibu');

                tr.innerHTML = `
                    <td class="p-4">
                        <button onclick="copyAction('${row.no_hp}', ${index}, 'hp', this)" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 w-full font-bold shadow-sm active:scale-95 transition-all">Copy HP</button>
                    </td>
                    <td class="p-4">
                        <button onclick="copyAction('${formattedName}', ${index}, 'name', this)" class="bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 mb-1 block w-full font-bold shadow-sm active:scale-95 transition-all">Copy Nama</button>
                        <span class="text-[10px] text-slate-400 font-mono block text-center truncate w-24 mx-auto">${formattedName}</span>
                    </td>
                    <td class="p-4">
                        <button onclick="copyAction('${randomMsg}', ${index}, 'msg', this)" class="bg-orange-500 text-white px-3 py-2 rounded-lg hover:bg-orange-600 mb-1 block w-full font-bold shadow-sm active:scale-95 transition-all">Copy Pesan</button>
                    </td>
                    <td class="p-4 text-center font-bold text-xs" id="status-${index}"><span class="text-slate-300 italic">BELUM</span></td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function copyAction(text, index, type, btn) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                rowTracker[index][type] = true;
                btn.classList.add('btn-active-copy');
                btn.innerText = "OK";
                checkRowCompletion(index);
            } catch (err) { console.error('Gagal copy', err); }
            document.body.removeChild(textArea);
        }

        function checkRowCompletion(index) {
            const rowData = rowTracker[index];
            if (rowData.hp && rowData.name && rowData.msg && !rowData.completed) {
                rowData.completed = true;
                
                // Update Total Tercopy
                processedTotal++;
                document.getElementById('successCount').innerText = processedTotal;

                // Update Sesi Pengiriman
                sessionCounter++;
                updateSessionUI();

                // Efek Baris
                const row = document.getElementById(`row-${index}`);
                const statusCell = document.getElementById(`status-${index}`);
                row.classList.add('row-complete');
                statusCell.innerHTML = '<span class="text-green-600 font-black">‚úì TERCOPY</span>';

                // Alert jika sudah 5 pesan
                if (sessionCounter >= 5) {
                    alert("‚ö†Ô∏è PERINGATAN JEDA: Anda sudah mengirim 5 pesan. Harap berhenti sejenak selama 5-10 menit sebelum lanjut ke sesi berikutnya agar WA tidak terblokir.");
                }
            }
        }

        function updateSessionUI() {
            const sessionEl = document.getElementById('sessionCount');
            const cardEl = document.getElementById('sessionCard');
            const alertEl = document.getElementById('pauseAlert');
            
            sessionEl.innerText = `${sessionCounter} / 5`;
            
            if (sessionCounter >= 5) {
                cardEl.classList.replace('bg-white', 'bg-red-50');
                cardEl.classList.add('border-red-300');
                sessionEl.classList.replace('text-blue-600', 'text-red-600');
                alertEl.classList.remove('hidden');
            } else {
                cardEl.classList.replace('bg-red-50', 'bg-white');
                cardEl.classList.remove('border-red-300');
                sessionEl.classList.replace('text-red-600', 'text-blue-600');
                alertEl.classList.add('hidden');
            }
        }

        function resetSession() {
            sessionCounter = 0;
            updateSessionUI();
        }
    </script>
</body>
</html>